<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Gmail Checker</title>
    <script src="jquery-1.4.2.min.js"></script>
    <script>
    safari.application.addEventListener("command", clickHandler, false);
    safari.application.addEventListener("validate", checkHandler, false);
    safari.extension.settings.addEventListener("change", settingsChanged, false);
    
    connectionOptions = {
      url: "https://mail.google.com/mail/feed/atom",
    };
    
    function clickHandler() {
      var newTab = safari.application.activeBrowserWindow.openTab();
      newTab.url = "http://mail.google.com";
    }
    
    function checkHandler() {
      var username = safari.extension.secureSettings.getItem("username");
      var password = safari.extension.secureSettings.getItem("password");
      
      if (!username || !password) {
        return;
      }
      
      var connect = $.extend({
        username: username,
        password: escape(password),
        
        success: function(d) {
          $.each(safari.extension.toolbarItems, function(i, v) {
            v.badge = $("entry", d).size();
          });
        }
      }, connectionOptions);
      $.ajax(connect);
    }
    
    function settingsChanged(event) {
      if (event.key == "update") {
        safari.extension.globalPage.contentWindow.clearInterval(updater);
        updater = safari.extension.globalPage.contentWindow.setInterval(checkHandler, event.newValue);
      }
    }
    
    var updater = safari.extension.globalPage.contentWindow.setInterval(checkHandler, safari.extension.settings.getItem("update"));
    </script>
  </head>
</html>
