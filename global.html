<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Gmail Checker</title>
    <script src="jquery-1.4.2.min.js"></script>
    <script>
    safari.application.addEventListener("command", commandHandler, false);
    safari.application.addEventListener("validate", checkInbox, false);
    safari.extension.settings.addEventListener("change", settingsChanged, false);
    
    connectionOptions = {
      url: "https://mail.google.com/mail/feed/atom",
    };
    
    function commandHandler() {
      var newTab = safari.application.activeBrowserWindow.openTab();
      newTab.url = "http://mail.google.com";
    }
    
    function checkInbox() {      
      doIfLoggedIn(function() {
        $.ajax({
          url: "https://mail.google.com/mail/feed/atom",
          success: function(d) { updateBadge($("entry", d).size()); }
        });
      },
      function() { updateBadge(0); });
    }
    
    function doIfLoggedIn(func, func_else) {
      $.ajax({
        url: "http://mail.google.com/mail/",
        success: function(d) {
          // A crude login check: The Google login page uses Quirks mode; the "Loading inbox" screen is HTML5
          // This is to avoid calling the Feed unless we're authorized (since this will display a HTTP Auth sheet)
          
          // It's not perfect â€“ because (Safari is especially crappy here) there's sometimes lag
          // between Gmail login and Feed auth
          if (!d.indexOf("<!DOCTYPE html>")) {
            func();
          }
          else {
            func_else();
          }
        }
      });
    }
    
    function updateBadge(n) {
      $.each(safari.extension.toolbarItems, function(i, v) {
        v.badge = n;
      });
    }
    
    function settingsChanged(event) {
      if (event.key == "update") {
        safari.extension.globalPage.contentWindow.clearInterval(updater);
        updater = safari.extension.globalPage.contentWindow.setInterval(checkInbox, event.newValue * 1000);
      }
    }
    
    var updater = safari.extension.globalPage.contentWindow.setInterval(checkInbox, safari.extension.settings.getItem("update") * 1000);
    </script>
  </head>
</html>
